<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<div class="product-image-slider-container">
  <div id="product-images--slider">
    {% for image in product.images %}
      <div class="item" data-image-id="{{ image.id }}">
        <img src="{{ image | img_url: 'master' }}" alt="{{ image.alt | escape }}">
      </div>
    {% endfor %}
  </div>

  <!-- Round navigation buttons -->
  <div id="product-images--nav" class="slider-nav">
    {% for image in product.images %}
      <div class="nav-item" data-image-id="{{ image.id }}">
        <div class="nav-dot"></div>
      </div>
    {% endfor %}
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

<script>
  var $product_image_slider_obj;

  // Initialize slick
  $product_image_slider_obj = $('#product-images--slider').on('init', function () {
    // Set first dot active after slick is ready
    updateNavigationDots(0);
  }).slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: false,
    autoplay: false,
    infinite: false, // keep false; we handle wrap manually on hover
    fade: true,
    speed: 300
  });

  // Sync dots on slide change
  $product_image_slider_obj.on('afterChange', function (event, slick, currentSlide) {
    updateNavigationDots(currentSlide);
  });

  // Click nav dots -> go to slide
  $(document).on('click', '#product-images--nav .nav-item', function () {
    var slideIndex = $(this).index();
    $product_image_slider_obj.slick('slickGoTo', slideIndex);
  });

  // ----- Edge-based wrap + zone hover -----
  var EDGE_PX = 60; // how close to edge to trigger wrap (tweak as needed)
  var hoverTicking = false;

  $('#product-images--slider').on('mousemove', function (e) {
    if (hoverTicking) return;
    hoverTicking = true;

    requestAnimationFrame(() => {
      var $el = $(this);
      var containerWidth = $el.width();
      var offsetLeft = $el.offset().left;
      var mouseX = e.pageX - offsetLeft;

      var slickInst = $product_image_slider_obj.slick('getSlick');
      var slideCount = slickInst.slideCount;
      var currentSlide = slickInst.slickCurrentSlide();

      // 1) Check if mouse is in left edge zone
      if (mouseX <= EDGE_PX) {
        // Always show last image when in left edge
        if (currentSlide !== slideCount - 1) {
          $product_image_slider_obj.slick('slickGoTo', slideCount - 1);
        }
        hoverTicking = false;
        return;
      }
      
      // 2) Check if mouse is in right edge zone
      if (mouseX >= containerWidth - EDGE_PX) {
        // Always show first image when in right edge
        if (currentSlide !== 0) {
          $product_image_slider_obj.slick('slickGoTo', 0);
        }
        hoverTicking = false;
        return;
      }

      // 3) Zone-based hover for middle area (excluding edges)
      var slideIndex = Math.floor((mouseX / containerWidth) * slideCount);
      if (slideIndex < 0) slideIndex = 0;
      if (slideIndex >= slideCount) slideIndex = slideCount - 1;

      if (slideIndex !== currentSlide) {
        $product_image_slider_obj.slick('slickGoTo', slideIndex);
      }

      hoverTicking = false;
    });
  });

  // Mouse leave -> go back to first slide
  $('#product-images--slider').on('mouseleave', function () {
    $product_image_slider_obj.slick('slickGoTo', 0);
  });

  function updateNavigationDots(currentSlide) {
    $('#product-images--nav .nav-item').removeClass('active');
    $('#product-images--nav .nav-item').eq(currentSlide).addClass('active');
  }
</script>

<style>
  .product-image-slider-container {
    position: relative;
    width: 100%;
  }

  #product-images--slider {
    width: 100%;
    cursor: pointer;
  }

  #product-images--slider .item img {
    width: 100%;
    height: auto;
    display: block;
  }

  .slider-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
    padding: 0 20px;
  }

  .nav-item {
    cursor: pointer;
    padding: 5px;
    transition: all 0.3s ease;
  }

  .nav-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #d9d9d9;
    transition: all 0.3s ease;
  }

  .nav-item.active .nav-dot {
    background-color: #000;
    transform: scale(1.2);
  }

  .nav-item:hover .nav-dot {
    background-color: #666;
    transform: scale(1.1);
  }

  .nav-item.active:hover .nav-dot {
    background-color: #000;
    transform: scale(1.3);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .slider-nav {
      margin-top: 15px;
      gap: 6px;
    }

    .nav-dot {
      width: 6px;
      height: 6px;
    }
  }
</style>
